#!/bin/sh
# .git/hooks/pre-commit

echo "üîç Running pre-commit checks..."

# Configuration
ROOT_DIR=$(git rev-parse --show-toplevel)
SERVICES_DIR="$ROOT_DIR"  # Adjust if services are in a subdirectory like "services/"

# Get changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
JAVA_FILES=$(echo "$CHANGED_FILES" | grep '\.java$')
JS_TS_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json|css|scss|md)$')

FAILED=0

# ==================== JAVA/SPOTLESS CHECK ====================
if [ -n "$JAVA_FILES" ]; then
    echo ""
    echo "‚òï Processing Java files with Spotless..."
    
    # Extract unique service directories
    SERVICES=$(echo "$JAVA_FILES" | cut -d'/' -f1 | sort -u)
    
    for service in $SERVICES; do
        SERVICE_PATH="$SERVICES_DIR/$service"
        
        # Check if it's a gradle project
        if [ -f "$SERVICE_PATH/build.gradle" ] || [ -f "$SERVICE_PATH/build.gradle.kts" ]; then
            echo "üì¶ Formatting $service..."
            
            # Determine which gradle wrapper to use
            if [ -f "$SERVICE_PATH/gradlew" ]; then
                cd "$SERVICE_PATH"
                ./gradlew spotlessApply
                RESULT=$?
                cd "$ROOT_DIR"
            elif [ -f "$ROOT_DIR/gradlew" ]; then
                ./gradlew :$service:spotlessApply
                RESULT=$?
            else
                echo "‚ö†Ô∏è  No gradlew found for $service, skipping..."
                continue
            fi
            
            if [ $RESULT -ne 0 ]; then
                echo "‚ùå Spotless failed for $service"
                FAILED=1
            else
                echo "‚úÖ $service formatted successfully"
            fi
        fi
    done
    
    # Stage formatted Java files
    echo "$JAVA_FILES" | while read -r file; do
        if [ -f "$ROOT_DIR/$file" ]; then
            git add "$ROOT_DIR/$file"
        fi
    done
else
    echo "‚ÑπÔ∏è  No Java files changed."
fi

# ==================== NEXT.JS/PRETTIER CHECK ====================
if [ -n "$JS_TS_FILES" ]; then
    echo ""
    echo "‚öõÔ∏è  Processing Next.js files..."
    
    # Find Next.js project directory (adjust path if needed)
    NEXTJS_DIR="$ROOT_DIR/web"  # Change to "$ROOT_DIR/frontend" or "$ROOT_DIR/web" if needed
    
    # Check if package.json exists
    if [ -f "$NEXTJS_DIR/package.json" ]; then
        cd "$NEXTJS_DIR"
        
        # Check if node_modules exists
        if [ ! -d "node_modules" ]; then
            echo "‚ö†Ô∏è  node_modules not found. Please run 'npm install' or 'yarn install'"
            FAILED=1
        else
            # Run Prettier
            echo "üé® Running Prettier..."
            if command -v npx >/dev/null 2>&1; then
                echo "$JS_TS_FILES" | xargs npx prettier --write
                PRETTIER_RESULT=$?
            else
                echo "‚ùå npx not found. Please install Node.js"
                FAILED=1
                PRETTIER_RESULT=1
            fi
            
            if [ $PRETTIER_RESULT -ne 0 ]; then
                echo "‚ùå Prettier formatting failed"
                FAILED=1
            else
                echo "‚úÖ Prettier formatting completed"
            fi
            
            # Run ESLint
            echo "üîç Running ESLint..."
            if command -v npx >/dev/null 2>&1; then
                npx next lint
                LINT_RESULT=$?
            else
                echo "‚ùå npx not found. Please install Node.js"
                FAILED=1
                LINT_RESULT=1
            fi
            
            if [ $LINT_RESULT -ne 0 ]; then
                echo "‚ùå ESLint found errors - commit blocked!"
                FAILED=1
            else
                echo "‚úÖ ESLint passed"
            fi
        fi
        
        cd "$ROOT_DIR"
        
        # Stage formatted JS/TS files
        echo "$JS_TS_FILES" | while read -r file; do
            if [ -f "$ROOT_DIR/$file" ]; then
                git add "$ROOT_DIR/$file"
            fi
        done
    else
        echo "‚ö†Ô∏è  package.json not found in $NEXTJS_DIR, skipping Next.js checks..."
    fi
else
    echo "‚ÑπÔ∏è  No Next.js files changed."
fi

# ==================== FINAL CHECK ====================
echo ""
if [ $FAILED -eq 1 ]; then
    echo "‚ùå Pre-commit checks failed!"
    echo "Please fix the errors above and try committing again."
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0