#!/bin/bash
FILES=$(git diff --cached --name-only)

if [ -z "$FILES" ]; then
  exit 0
fi

# Track whether any service fails
HAS_ERRORS=0

# Extract unique top-level directories
SERVICES=$(echo "$FILES" | awk -F/ '{print $1}' | sort -u)

for service in $SERVICES; do

  if [ ! -d "$service" ]; then
    continue
  fi

  if [ -f "$service/build.gradle" ] || [ -f "$service/pom.xml" ]; then
    (cd "$service" && ./gradlew spotlessApply)
    if [[ $? -ne 0 ]]; then
      echo "❌ Spotless failed in $service"
      HAS_ERRORS=1
    fi
  fi

  if [ -f "$service/go.mod" ]; then
    (cd "$service" && go fmt ./... && go vet ./...)
    if [[ $? -ne 0 ]]; then
      echo "❌ Go fmt/vet failed in $service"
      HAS_ERRORS=1
    fi
  fi

  if [ -f "$service/package.json" ]; then
    (cd "$service" && npx lint-staged)
    if [[ $? -ne 0 ]]; then
      echo "❌ lint-staged failed in $service"
      HAS_ERRORS=1
    fi
  fi

  MODIFIED=$(git ls-files -m "$service")

  if [ -n "$MODIFIED" ]; then
    echo "$MODIFIED" | xargs git add
  fi

done

if [[ $HAS_ERRORS -eq 1 ]]; then
  echo "❌ Pre-commit checks failed. Commit aborted."
  exit 1
fi

echo "✅ All checks passed."
exit 0
