#!/bin/bash

echo "üîç Detecting changed services..."

FILES=$(git diff --cached --name-only)

if [ -z "$FILES" ]; then
  exit 0
fi

# Extract unique service directories
SERVICES=$(echo "$FILES" | awk -F/ '{print $1}' | sort -u)

for service in $SERVICES; do
  echo ""
  echo "‚û°Ô∏è Processing $service"

  if [ ! -d "$service" ]; then
    echo "Skipping: not a directory"
    continue
  fi

  # Java (Spotless)
  if [ -f "$service/build.gradle" ] || [ -f "$service/pom.xml" ]; then
    echo "üü° Java service ‚Üí spotlessApply"
    (cd "$service" && ./gradlew spotlessApply)
  fi

  # Go
  if [ -f "$service/go.mod" ]; then
    echo "üîµ Go service ‚Üí fmt + vet"
    (cd "$service" && go fmt ./... && go vet ./...)
  fi

  # JS/TS/Next.js
  if [ -f "$service/package.json" ]; then
    echo "üü£ JS/TS service ‚Üí lint-staged"
    (cd "$service" && npx lint-staged)
  fi

  # -----------------------------------------
  # üß† ONLY re-stage modified files in service
  # -----------------------------------------
  echo "‚ôªÔ∏è  Re-staging modified files inside: $service"
  MODIFIED=$(git ls-files -m "$service")

  if [ -n "$MODIFIED" ]; then
    echo "$MODIFIED" | xargs git add
  else
    echo "No files to re-stage."
  fi

done

exit 0
